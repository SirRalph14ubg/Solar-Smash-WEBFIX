<script>
document.addEventListener("DOMContentLoaded", () => {
  // ===== CONFIG =====
  const s3Url = "https://solar-smash-webgl.s3.us-east-2.amazonaws.com"; // S3 for data/wasm/assets
  const cdnUrl = "https://cdn.jsdelivr.net/gh/dartsc/Solar-Smash-WEBFIX@latest"; // jsDelivr for loader/framework
  const loaderUrl = cdnUrl + "/Build.loader.js";
  const ytApiUrl = "https://www.youtube.com/game_api/v1";

  // ===== CREATE CONTAINER =====
  const container = document.createElement("div");
  container.id = "unity-container";
  Object.assign(container.style, {
    position: "fixed",
    top: "0",
    left: "0",
    width: "100%",
    height: "100%",
    background: "#000"
  });
  document.body.appendChild(container);

  // ===== CREATE CANVAS =====
  const canvas = document.createElement("canvas");
  canvas.id = "unity-canvas";
  canvas.tabIndex = -1;
  canvas.style.width = "100%";
  canvas.style.height = "100%";
  container.appendChild(canvas);

  // Ensure WebGL buffer matches screen resolution
  function resizeCanvas() {
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
  }
  window.addEventListener("resize", resizeCanvas);
  resizeCanvas();

  // ===== CREATE LOADING BAR =====
  const loadingBar = document.createElement("div");
  Object.assign(loadingBar.style, {
    position: "absolute",
    top: "50%",
    left: "50%",
    transform: "translate(-50%, -50%)",
    width: "50%",
    maxWidth: "600px"
  });
  container.appendChild(loadingBar);

  const progressBarEmpty = document.createElement("div");
  Object.assign(progressBarEmpty.style, {
    width: "100%",
    height: "20px",
    background: "#ccc",
    borderRadius: "10px",
    overflow: "hidden"
  });
  loadingBar.appendChild(progressBarEmpty);

  const progressBarFull = document.createElement("div");
  Object.assign(progressBarFull.style, {
    width: "0%",
    height: "100%",
    background: "#4caf50",
    transition: "width 0.2s ease"
  });
  progressBarEmpty.appendChild(progressBarFull);

  // ===== CREATE WARNING BANNER =====
  const warningBanner = document.createElement("div");
  Object.assign(warningBanner.style, {
    position: "absolute",
    top: "0",
    width: "100%",
    textAlign: "center",
    color: "white",
    background: "red",
    display: "none"
  });
  container.appendChild(warningBanner);

  function unityShowBanner(msg, type) {
    warningBanner.style.display = "block";
    warningBanner.textContent = msg;
    if (type === "error") warningBanner.style.background = "red";
    if (type === "warning") {
      warningBanner.style.background = "yellow";
      warningBanner.style.color = "black";
    }
  }

  // ===== UNITY CONFIG =====
  const config = {
    dataUrl: s3Url + "/Build/Build.data",
    frameworkUrl: cdnUrl + "/Build.framework.js",
    codeUrl: s3Url + "/Build/Build.wasm",
    DynamicUI: s3Url + "/StreamingAssets/AssetBundles/WebGL/dynamic_ui",
    UI: s3Url + "/StreamingAssets/AssetBundles/WebGL/ui",
    Localisation: s3Url + "/StreamingAssets/AssetBundles/WebGL/localisation",
    audio_ui: s3Url + "/StreamingAssets/AssetBundles/WebGL/audio_ui",
    music: s3Url + "/StreamingAssets/AssetBundles/WebGL/music",
    fonts: s3Url + "/StreamingAssets/AssetBundles/WebGL/fonts",
    audio_weapons: s3Url + "/StreamingAssets/AssetBundles/WebGL/audio_weapons",
    planets: s3Url + "/StreamingAssets/AssetBundles/WebGL/planets",
    weapons: s3Url + "/StreamingAssets/AssetBundles/WebGL/weapons",
    companyName: "Paradyme Games",
    productName: "Solar Smash FIX",
    productVersion: "0.1.0",
    showBanner: unityShowBanner,
    autoSyncPersistentDataPath: true
  };

  // ===== MOBILE / DESKTOP ADJUSTMENTS =====
  if (/iPhone|iPad|iPod|Android/i.test(navigator.userAgent)) {
    const meta = document.createElement("meta");
    meta.name = "viewport";
    meta.content = "width=device-width, height=device-height, initial-scale=1.0, maximum-scale=1.0, user-scalable=no";
    document.head.appendChild(meta);
    container.className = "unity-mobile";
    canvas.className = "unity-mobile";
  }

  loadingBar.style.display = "block";

  // ===== FIX: UNLOCK AUDIO =====
  function unlockAudioContext() {
    if (typeof AudioContext !== "undefined") {
      const ctx = new AudioContext();
      if (ctx.state === "suspended") {
        const resume = () => {
          ctx.resume().then(() => {
            console.log("AudioContext resumed");
            document.removeEventListener("click", resume);
            document.removeEventListener("touchstart", resume);
            ctx.close(); // close temp context, Unity will create its own
          });
        };
        document.addEventListener("click", resume, { once: true });
        document.addEventListener("touchstart", resume, { once: true });
      }
    }
  }

  // ===== LOAD YT GAME API =====
  function loadYTGameAPI(callback) {
    const ytScript = document.createElement("script");
    ytScript.src = ytApiUrl;
    ytScript.onload = callback;
    ytScript.onerror = () => callback(); // fallback if YT fails
    document.body.appendChild(ytScript);
  }

  // ===== INITIALIZE UNITY =====
  function InitUnitySection() {
    const script = document.createElement("script");
    script.src = loaderUrl;
    script.onload = () => {
      createUnityInstance(canvas, config, (progress) => {
        progressBarFull.style.width = (progress * 100) + "%";
      }).then(instance => {
        window.unityGameInstance = instance;
        loadingBar.style.display = "none";
      }).catch(console.error);
    };
    document.body.appendChild(script);
  }

  // ===== START LOADING =====
  unlockAudioContext();
  loadYTGameAPI(InitUnitySection);
});
</script>
