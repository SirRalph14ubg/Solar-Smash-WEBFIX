<script>
document.addEventListener("DOMContentLoaded", () => {
  // ===== CONFIG =====
  const s3Url = "https://solar-smash-webgl.s3.us-east-2.amazonaws.com";
  const cdnUrl = "https://cdn.jsdelivr.net/gh/dartsc/Solar-Smash-FIX@latest/Build";
  const loaderUrl = cdnUrl + "/Build.loader.js";

  // ===== CREATE CONTAINER =====
  const container = document.createElement("div");
  container.id = "unity-container";
  Object.assign(container.style, {
    position: "fixed",
    top: "0",
    left: "0",
    width: "100%",
    height: "100%",
    background: "#000"
  });
  document.body.appendChild(container);

  // ===== CREATE CANVAS =====
  const canvas = document.createElement("canvas");
  canvas.id = "unity-canvas";
  canvas.tabIndex = -1;
  Object.assign(canvas.style, { width: "100%", height: "100%" });
  container.appendChild(canvas);

  // ===== CREATE LOADING BAR =====
  const loadingBar = document.createElement("div");
  loadingBar.id = "unity-loading-bar";
  Object.assign(loadingBar.style, {
    position: "absolute",
    top: "50%",
    left: "50%",
    transform: "translate(-50%, -50%)",
    width: "50%",
    maxWidth: "600px"
  });
  container.appendChild(loadingBar);

  const progressBarEmpty = document.createElement("div");
  progressBarEmpty.id = "unity-progress-bar-empty";
  progressBarEmpty.style.width = "100%";
  progressBarEmpty.style.background = "#ccc";
  loadingBar.appendChild(progressBarEmpty);

  const progressBarFull = document.createElement("div");
  progressBarFull.id = "unity-progress-bar-full";
  Object.assign(progressBarFull.style, {
    width: "0%",
    height: "20px",
    background: "#4caf50"
  });
  progressBarEmpty.appendChild(progressBarFull);

  // ===== CREATE WARNING BANNER =====
  const warningBanner = document.createElement("div");
  warningBanner.id = "unity-warning";
  Object.assign(warningBanner.style, {
    position: "absolute",
    top: "0",
    width: "100%",
    textAlign: "center",
    color: "white",
    background: "red",
    display: "none"
  });
  container.appendChild(warningBanner);

  function unityShowBanner(msg, type) {
    warningBanner.style.display = "block";
    warningBanner.textContent = msg;
    if (type === "error") warningBanner.style.background = "red";
    if (type === "warning") {
      warningBanner.style.background = "yellow";
      warningBanner.style.color = "black";
    }
  }

  // ===== UNITY CONFIG =====
  const config = {
    dataUrl: s3Url + "/Build.data",
    frameworkUrl: cdnUrl + "/Build.framework.js",
    codeUrl: s3Url + "/Build.wasm",
    DynamicUI: cdnUrl + "/StreamingAssets/AssetBundles/WebGL/dynamic_ui",
    UI: cdnUrl + "/StreamingAssets/AssetBundles/WebGL/ui",
    Localisation: cdnUrl + "/StreamingAssets/AssetBundles/WebGL/localisation",
    audio_ui: cdnUrl + "/StreamingAssets/AssetBundles/WebGL/audio_ui",
    music: cdnUrl + "/StreamingAssets/AssetBundles/WebGL/music",
    fonts: cdnUrl + "/StreamingAssets/AssetBundles/WebGL/fonts",
    audio_weapons: cdnUrl + "/StreamingAssets/AssetBundles/WebGL/audio_weapons",
    planets: cdnUrl + "/StreamingAssets/AssetBundles/WebGL/planets",
    weapons: cdnUrl + "/StreamingAssets/AssetBundles/WebGL/weapons",
    companyName: "Paradyme Games",
    productName: "Solar Smash FIX",
    productVersion: "0.1.0",
    showBanner: unityShowBanner,
    autoSyncPersistentDataPath: true
  };

  // ===== MOBILE / DESKTOP ADJUSTMENTS =====
  if (/iPhone|iPad|iPod|Android/i.test(navigator.userAgent)) {
    const meta = document.createElement('meta');
    meta.name = 'viewport';
    meta.content = 'width=device-width, height=device-height, initial-scale=1.0, user-scalable=no, shrink-to-fit=yes';
    document.head.appendChild(meta);
    container.className = "unity-mobile";
    canvas.className = "unity-mobile";
  } else {
    canvas.style.width = "100%";
    canvas.style.height = "100%";
  }

  loadingBar.style.display = "block";

  // ===== INITIALIZE UNITY =====
  function InitUnitySection() {
    const script = document.createElement("script");
    script.src = loaderUrl;
    script.onload = () => {
      createUnityInstance(canvas, config, (progress) => {
        progressBarFull.style.width = (progress * 100) + "%";
      }).then(instance => {
        window.unityGameInstance = instance;
        loadingBar.style.display = "none";
      }).catch(console.error);
    };
    document.body.appendChild(script);
  }

  // ===== LOAD YOUTUBE GAME API FIRST =====
  const ytScript = document.createElement("script");
  ytScript.src = "https://www.youtube.com/game_api/v1";
  ytScript.onload = () => {
    InitUnitySection();
  };
  document.head.appendChild(ytScript);
});
</script>